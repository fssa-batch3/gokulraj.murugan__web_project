<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../Assets/Css/Exchange.css">
    <title>Document</title>
</head>

<body>
    <div class="navigation">
        <div>
            <img src="../Assets/Images/Screenshot__74..png" width="90%" id="logo" alt="">
        </div>

        <ul>

            <li>
                <a href="./dashboard.html">
                    <span class="icon">
                        <i class="fa-solid fa-house"></i>
                    </span>
                    <span class="title">Home</span>
                </a>
            </li>
            <li>
                <a href="./Exchange.html">
                    <span class="icon">
                        <i class="fa-solid fa-arrows-rotate"></i>
                    </span>
                    <span class="title">Exchange</span>
                </a>
            </li>
            <li>
                <a href="./wallet.html">
                    <span class="icon">
                        <i class="fa-solid fa-wallet"></i>
                    </span>
                    <span class="title">Wallet</span>
                </a>
            </li>
            <li>
                <a href="./cryptos.html">
                    <span class="icon">
                        <i class="fa-solid fa-square-poll-vertical"></i>
                    </span>
                    <span class="title">Chart</span>
                </a>
            </li>
            <li>
                <a href="./profile.html">
                    <span class="icon">
                        <i class="fa-solid fa-user"></i>
                    </span>
                    <span class="title">Profile</span>
                </a>
            </li>
            <li>
                <a href="#">
                    <span class="icon">
                        <i class="fa-solid fa-gear"></i>
                    </span>
                    <span class="title">Settings</span>
                </a>
            </li>
        </ul>
    </div>
    <div class="all">

        <div class="head">
            <h3>
                <a href="./Exchange.html">Buy</a>
            </h3>
            <button id="sell_button" type="button">Sell</button>
            <div>
                <input type="search" name="search" placeholder="Search" id="search">
            </div>
        </div>
        <hr class="line">

        <div class="main">

            <div class="exchagnes">
                <h2 class="crypto_name">Bitcoin</h2>
                <div data-id="bitcoin" class="cards">
                </div>
            </div>
            <div class="exchagnes">
                <h2 class="crypto_name">Tether</h2>
                <div data-id="tether" class="cards">
                </div>
            </div>
            <div class="exchagnes">
                <h2 class="crypto_name">Doge Coin</h2>
                <div data-id="dogecoin" class="cards">
                </div>
            </div>
            <div class="exchagnes">
                <h2 class="crypto_name">Solana</h2>
                <div data-id="solana" class="cards">
                </div>
            </div>
            <div class="exchagnes">
                <h2 class="crypto_name">Ethereum</h2>
                <div data-id="ethereum" class="cards">
                </div>
            </div>
            <div class="exchagnes">
                <h2 class="crypto_name">Lite Coin</h2>
                <div data-id="litecoin" class="cards">
                </div>
            </div>
            <div class="exchagnes">
                <h2 class="crypto_name">Binance</h2>
                <div data-id="binance" class="cards">
                </div>
            </div>
            <div class="exchagnes">
                <h2 class="crypto_name">Cardano</h2>
                <div data-id="cardano" class="cards">
                </div>
            </div>

            <!-- pop up -->
            <div id="overlay"></div>
            <div class="popup">

                <div>
                    <a href="#">
                        <i class="fa-solid fa-xmark" id="close-btn"></i>
                    </a>
                </div>
                <form id="form">
                    <label for="cryoto_name2" class="coiname">COIN </label>
                    <input type="text" name="cryoto_name2" id="crypto_name" required>
                    <br>

                    <label for="crypto">HOW MANY COINS </label>
                    <input type="number" name="crypto" id="no_of_coins" required>
                    <br>

                    <label for="crypto">MONEY </label>
                    <input type="number" name="money" id="money" required>
                    <br>

                    <div class="coin">
                        <div class="one_coin">
                            <img src="../Assets/Images/Logo/btc.png" alt="" width="40px" height="40px">
                            <h3>Bitcoin</h3>
                            <h6>BTC</h6>
                        </div>
                        <div class="one_coin">
                            <img src="../Assets/Images/Logo/doge.png" alt="" width="40px" height="40px">
                            <h3>Tether</h3>
                            <h6>USDT</h6>
                        </div>
                        <div class="one_coin">
                            <img src="../Assets/Images/Logo/eth.png" alt="" width="40px" height="40px">
                            <h3>Ethereum</h3>
                            <h6>ETH</h6>
                        </div>
                        <div class="one_coin">
                            <img src="../Assets/Images/Logo/bnb.png" alt="" width="40px" height="40px">
                            <h3>Binace</h3>
                            <h6>BNB</h6>
                        </div>
                        <div class="one_coin">
                            <img src="../Assets/Images/Logo/usd.png" alt="" width="40px" height="40px">
                            <h3>USD Coin</h3>
                            <h6>USD</h6>
                        </div>
                        <div class="one_coin">
                            <img src="../Assets/Images/Logo/doge.png" alt="" width="40px" height="40px">
                            <h3>Doge Coin</h3>
                            <h6>DOGE</h6>
                        </div>
                        <div class="one_coin">
                            <img src="../Assets/Images/Logo/sol.png" alt="" width="40px" height="40px">
                            <h3>Solana</h3>
                            <h6>SOL</h6>
                        </div>
                        <div class="one_coin">
                            <img src="../Assets/Images/Logo/bnb.png" alt="" width="40px" height="40px">
                            <h3>LiteCoin</h3>
                            <h6>LTC</h6>
                        </div>
                        <div class="one_coin">
                            <img src="../Assets/Images/Logo/btc.png" alt="" width="40px" height="40px">
                            <h3>Shiba Inu</h3>
                            <h6>SHIB</h6>
                        </div>
                        <div class="one_coin">
                            <img src="../Assets/Images/Logo/btc.png" alt="" width="40px" height="40px">
                            <h3>Ape coin</h3>
                            <h6>APE</h6>
                        </div>
                        <div class="one_coin">
                            <img src="../Assets/Images/Logo/btc.png" alt="" width="40px" height="40px">
                            <h3>Flow</h3>
                            <h6>FLOW</h6>
                        </div>
                        <div class="one_coin">
                            <img src="../Assets/Images/Logo/btc.png" alt="" width="40px" height="40px">
                            <h3>Neo</h3>
                            <h6>NEO</h6>
                        </div>

                    </div>
                    <button id="sell">Sell</button>
                </form>
            </div>

        </div>
        <script src="https://kit.fontawesome.com/ee40c53027.js" crossorigin="anonymous" integrity="">
        </script>
        <!-- <script src="../Assets/js/exchange.js"></script> -->

        <script>
            const login = JSON.parse(localStorage.getItem("login"));

            const user_detail = JSON.parse(localStorage.getItem("userdata"));

            let user_id;
            let profile_image;
            let username;
            let value;
            let data_id;

            user_detail.find(e => {
                if (e.email == login.email) {
                    value = e;
                }
            })

            // console.log(value)

            user_id = value.user_id;
            username = value.username;
            profile_image = value.profile_pic;

            // console.log(user_id)

            const no_of_coins = document.getElementById("no_of_coins");
            const coin_div = document.querySelectorAll(".one_coin");
            const crypto = document.getElementById("crypto_name");
            const money = document.getElementById("money")
            crypto.addEventListener("keyup", (e) => {

                const currency = e.target.value.toLowerCase();
                let div;

                // console.log(currency)
                const one_coin = document.querySelectorAll(".one_coin");
                // console.log(one_coin)
                one_coin.forEach(element => {
                    // console.log(element)
                    const content = element.children[1].textContent.toLowerCase();

                    if (content.includes(currency)) {
                        element.style.display = "flex";
                    }
                    else {
                        element.style.display = "none";
                    }
                })
            });

            let data;
            let coin_img;
            let coin_symbol;
            coin_div.forEach((el) => {
                // console.log(el);
                if (el.addEventListener) {
                    el.addEventListener("click", () => {
                        data = el;
                        crypto.value = data.children[1].innerHTML
                        coin_img = data.children[0].src;
                        coin_symbol = data.children[2].innerText
                        console.log(coin_img);

                    })
                }
                else if (crypto.value == el.children[1].innerText) {
                    coin_img = el.children[0].src
                    console.log(coin_img);
                }
            })

            // Product Create starts
            function product_details() {
                const product_id = Math.floor(Math.random() * 100)
                const crypto_name = document.getElementById("crypto_name").value.toLowerCase();
                const no_of_coins = document.getElementById("no_of_coins").value;
                const money = document.getElementById("money").value;

                let res;

                const product_details = JSON.parse(localStorage.getItem("product_details")) ?? [];

                const product = {
                    "seller_id": user_id,
                    product_id,
                    crypto_name,
                    "seller_username": username,
                    no_of_coins,
                    money,
                    "profile_pic": profile_image,
                    coin_img,
                    "symbol": coin_symbol,
                }

                product_details.push(product)
                localStorage.setItem("product_details", JSON.stringify(product_details))
                window.location.href = "Exchange.html"

            }

            const check = document.getElementById("sell");
            check.addEventListener("click", e => {
                e.preventDefault()
                product_details()
            })
            // Product Create ends

            // Product Read starts
            product_detail = JSON.parse(localStorage.getItem("product_details"))
            // console.log(product_detail)
            if (product_detail == null) {

            }
            else {

                for (let i = 0; i < product_detail.length; i++) {

                    // <div class="onecard">
                    const onecard = document.createElement("div")
                    onecard.setAttribute("class", "onecard")
                    const crypto_data = document.querySelectorAll(".cards");

                    crypto_data.forEach((e) => {

                        if (e.dataset.id == product_detail[i].crypto_name) {
                            // console.log(e.dataset.id)
                            e.prepend(onecard)
                        }
                    })

                    // <div class="profile">
                    const profile = document.createElement("div")
                    profile.setAttribute("class", "profile")
                    onecard.append(profile)

                    // <img src="../Assets/Images/profile.png" class="user_photo" alt="">
                    const user_photo = document.createElement("img")
                    user_photo.setAttribute("src", product_detail[i].profile_pic)
                    user_photo.setAttribute("class", "user_photo")
                    user_photo.setAttribute("alt", "error_found")
                    profile.append(user_photo)

                    // <div class="coin_details">
                    const coin_details = document.createElement("div")
                    coin_details.setAttribute("class", "coin_details")
                    profile.append(coin_details)

                    // <div class="coin_details2">
                    const coin_details2 = document.createElement("div")
                    coin_details2.setAttribute("class", "coin_details2")
                    coin_details.append(coin_details2)

                    // <img src="../Assets/Images/Logo/btc.png" width="12%" alt="" class="crypto_image">
                    const crypto_image = document.createElement("img")
                    crypto_image.setAttribute("src", product_detail[i].coin_img)
                    crypto_image.setAttribute("class", "crypto_image")
                    crypto_image.setAttribute("alt", "error_found")
                    crypto_image.setAttribute("width", "12")
                    coin_details2.append(crypto_image)

                    //  <h4 class="crypto_name2">Bitcoin</h4>
                    const cryoto_name2 = document.createElement("h4")
                    cryoto_name2.setAttribute("class", "cryoto_name2")
                    cryoto_name2.innerText = product_detail[i].crypto_name
                    coin_details2.append(cryoto_name2)

                    // <h4 class="username">Username</h4>
                    const username = document.createElement("h4")
                    username.setAttribute("class", "username")
                    username.innerText = product_detail[i].seller_username
                    coin_details.append(username)

                    // <div class="exchange">
                    const exchange = document.createElement("div")
                    exchange.setAttribute("class", "exchange")
                    onecard.append(exchange)

                    const label = document.createElement("label")
                    label.setAttribute("id", "label1")
                    label.setAttribute("for", "crypto");
                    label.setAttribute("disabled", "");
                    label.innerText = product_detail[i].symbol
                    exchange.append(label)

                    // <input type="number" name="crypto" id="crypto" disabled>
                    const crypto = document.createElement("input")
                    crypto.setAttribute("type", "number")
                    crypto.setAttribute("name", "crypto")
                    crypto.setAttribute("id", "crypto")
                    crypto.setAttribute("disabled", "")
                    crypto.setAttribute("value", product_detail[i].no_of_coins)
                    exchange.append(crypto)

                    // <br>
                    const space = document.createElement("br")
                    exchange.append(space)

                    const label2 = document.createElement("label")
                    label2.setAttribute("for", "crypto");
                    label2.setAttribute("disabled", "");
                    label2.innerText = "INR"
                    exchange.append(label2)

                    // <input type="number" name="price" id="price" disabled>
                    const price = document.createElement("input")
                    price.setAttribute("type", "number")
                    price.setAttribute("name", "price")
                    price.setAttribute("id", "price")
                    price.setAttribute("disabled", "")
                    price.value = product_detail[i].money;
                    exchange.append(price)

                    // <br>
                    const space2 = document.createElement("br")
                    exchange.append(space2)

                    if (login.user_id == product_detail[i].user_id) {
                    }
                    else {
                        // <button class="buttons">Buy</button>
                        const buy_button = document.createElement("button")
                        buy_button.setAttribute("class", "buttons2")
                        buy_button.setAttribute("value", product_detail[i].product_id)
                        buy_button.innerText = "Buy"
                        exchange.append(buy_button);

                    }

                }
            }
            // Product Read ends

            // Pop up starts
            const sell_button = document.getElementById("sell_button")
            const overlay = document.querySelector('#overlay');
            const popup = document.querySelector('.popup');
            const closebtn = document.getElementById('close-btn');

            const save = document.getElementById("save")

            function openPopup() {
                popup.style.display = 'block';
                overlay.style.display = 'block';
            }

            function closePopup() {
                popup.style.display = 'none';
                overlay.style.display = 'none';
            }

            closebtn.addEventListener("click", closePopup);
            sell_button.addEventListener("click", openPopup);
            // Pop up ends

            // payment details create

            // let payment = JSON.parse(localStorage.getItem("payment_details"))
            const payment_id = document.querySelectorAll(".buttons2")
            let product_Id;
            let res;

            // live time code starts
            const now = new Date();
            let hours = now.getHours();
            let minutes = now.getMinutes();
            const amPm = hours < 12 ? 'am' : 'pm';
            // Convert from 24-hour to 12-hour format
            hours %= 12;
            hours = hours || 12;
            // Add leading zero to minutes if necessary
            minutes = minutes < 10 ? `0${minutes}` : minutes;
            const currentTime = `${hours}.${minutes} ${amPm}`;
            // time code ends

            // card balance code starts
            let card_balance = JSON.parse(localStorage.getItem("card_balance")) ?? []
            let seller_id;
            let coin_arr = [];
            let crypto_detail;
            let coins;
            let username22;
            let curr_index;
            let cryto_coinss;
            let ifnotobject;

            payment_id.forEach((data) => {
                console.log(data)
                data.addEventListener("click", () => {
                    product_Id = data.value

                    cryto_coinss = Number(data.parentElement.children[1].value);

                    username22 = data.parentElement.parentElement.children[0].children[1].children[1].innerText;

                    data_id = data.parentElement.parentElement.parentElement.dataset.id;
                    console.log(data_id)
                    product_detail.find((element) => {
                        if (product_Id == element.product_id) {

                            seller_id = element.seller_id

                            res = element

                            alert("are you sure you want to buy??")

                            payment_detail()

                        }
                    })

                    cardbalanace()
                })
            });

            function payment_detail() {

                const payment = JSON.parse(localStorage.getItem("payment_details")) ?? [];
                const order_id = Math.floor(Math.random() * 100);
                // console.log(res)

                const payment_details = {

                    "user_id": login.user_id,
                    "profile_pic": res.profile_pic,
                    "order_id": order_id,
                    "seller_id": seller_id,
                    "product_id": product_Id,
                    "crypto_name": res.crypto_name,
                    "no_of_coins": res.no_of_coins,
                    "money": res.money,
                    "seller_username": res.seller_username,
                    "time": currentTime,
                    "type": "Buy",
                }

                payment.push(payment_details)
                localStorage.setItem("payment_details", JSON.stringify(payment));
                // window.location.href = "./selectpayment.html"

            }

            let get_index;

            function cardbalanace() {

                if (localStorage.getItem("card_balance")) {
                    let card_balance1 = JSON.parse(localStorage.getItem("card_balance"))

                    card_balance1.find((balance) => {

                        if (balance["user_id"] === login["user_id"]) {

                            // for (let i = 0; i < card_balance1.length; i++) {

                            //     for (let j = 0; j < card_balance1[i]["coin_details"].length; j++) {

                            // crypto_detail = data_id;
                            balance["coin_details"].find((e) => {
                                if (data_id == e["coin_name"]) {

                                    return get_index = e

                                }
                            })


                            if (get_index) {
                                get_index["coins"] = Number(get_index["coins"]) + Number(cryto_coinss)

                                localStorage.setItem("card_balance", JSON.stringify(card_balance1))
                            }
                            else {
                                ifnotobject = {
                                    "coin_name": data_id,
                                    "coins": cryto_coinss
                                }
                                balance["coin_details"].push(ifnotobject)
                                localStorage.setItem("card_balance", JSON.stringify(card_balance1))
                            }


                        }
                        else {
                            console.log("front")


                        }

                    })

                }

                else {
                    // console.log("back")
                    card_balance = []
                    crypto_detail = data_id;

                    let coin_obj = {
                        "coin_name": crypto_detail,
                        "coins": cryto_coinss,
                    }

                    coin_arr.push(coin_obj)

                    let card = {
                        "coin_details": coin_arr,
                        "username": username22,
                        "user_id": login["user_id"],
                    }

                    // console.log(card)

                    card_balance.push(card)

                    localStorage.setItem("card_balance", JSON.stringify(card_balance));

                }
            }
        </script>

</body>

</html>